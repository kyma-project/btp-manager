apiVersion: v1
kind: ConfigMap
metadata:
  name: btpoperator-module
  namespace: kyma-system
  labels:
    app.kubernetes.io/managed-by: kyma
    app.kubernetes.io/name: btp-manager
    app.kubernetes.io/part-of: Kyma
    busola.io/extension: resource
    busola.io/extension-version: '0.5'
    kyma-project.io/module: btp-operator
    operator.kyma-project.io/managed-by: kyma
data:
  dataSources: |-
    relatedDeployments:
      resource:
        kind: Deployment
        version: v1
        group: apps
      filter: $item.metadata.labels.`kyma-project.io/module` = "btp-operator"
    relatedPods:
      resource:
        kind: Pod
        version: v1
      filter: $item.metadata.labels.`kyma-project.io/module` = "btp-operator"
    btpSecret:
      resource:
        kind: Secret
        version: v1
        namespace: kyma-system
        name: sap-btp-manager
    btpManagerDeployment:
      resource:
        kind: Deployment
        version: v1
        group: apps
        namespace: kyma-system
        name: btp-manager-controller-manager
    btpOperatorDeployment:
      resource:
        kind: Deployment
        version: v1
        group: apps
        namespace: kyma-system
        name: sap-btp-operator-controller-manager
    # 1. Default secret: sap-btp-service-operator (cluster-wide)
    defaultSecret:
      resource:
        kind: Secret
        version: v1
        namespace: null  # Explicitly search ALL namespaces
      filter: '$item.metadata.name = "sap-btp-service-operator"'
    # 2. Namespaced secrets: {namespace}-sap-btp-service-operator (cluster-wide)
    namespacedSecrets:
      resource:
        kind: Secret
        version: v1
        namespace: null  # Explicitly search ALL namespaces
      filter: '$contains($item.metadata.name, "-sap-btp-service-operator") and $item.metadata.name != "sap-btp-service-operator"'
    # 3. ServiceInstances (cluster-wide)
    allServiceInstances:
      resource:
        kind: ServiceInstance
        version: v1
        group: services.cloud.sap.com
        namespace: null  # Explicitly search ALL namespaces
    # 4. Referenced secrets
    referencedSecrets:
      resource:
        kind: Secret
        version: v1
        namespace: null  # Explicitly search ALL namespaces
      filter: '$item.metadata.name in $allServiceInstances().items.spec.btpAccessCredentialsSecret'
      
  general: |-
    resource:
      kind: BtpOperator
      group: operator.kyma-project.io
      version: v1alpha1
    name: BTP Operators
    category: Kyma
    urlPath: btpoperators
    scope: namespace
    description: >-
      BTP Operator enables consumption of SAP BTP services in your Kubernetes cluster.
    features:
      actions:
        disableCreate: true
        disableDelete: true
  
  list: |-
    - name: State
      source: status.state
      widget: Badge
      highlights:
        positive:
          - Ready
        negative:
          - Error
          - Deleting
        critical:
          - Warning
        informative:
          - Processing
  
  details: |-
    resourceGraph:
      dataSources:
        - source: relatedDeployments
        - source: relatedPods
        
    header:
      - name: Cluster ID
        source: $base64decode($btpSecret().data.cluster_id)
        widget: Text
        visibility: $exists($btpSecret().data.cluster_id)
        description: SAP BTP Cluster Identifier
      - name: Namespace
        source: metadata.namespace
      
    status:
      header:
        - source: status.state
          widget: Badge
          placeholder: '-'
          highlights:
            positive:
              - Running
              - ok
            critical: $item < 0
      body:
        - name: Conditions
          source: status.conditions
          visibility: $exists(status.conditions)
          widget: ConditionList
        - name: Generation
          source: metadata.generation
        - name: Installation Date
          source: metadata.creationTimestamp
        - name: SAP BTP Operator Module
          source: '"See Documentation"'
          link: '"https://help.sap.com/docs/btp/sap-business-technology-platform/sap-btp-operator-module"'
          widget: ExternalLink
        - name: BTP Manager Verision
          source: '$substringAfter($btpManagerDeployment().spec.template.spec.containers[0].image, ":")'
          widget: Text
        - name: BTP Operator Version
          source: '$substringAfter($btpOperatorDeployment().spec.template.spec.containers[1].image, ":v")'
          widget: Text
    body: 
      - name: SAP BTP Manager Secret - Decoded Data
        widget: Panel
        visibility: >-
          $exists(metadata.labels.`operator.kyma-project.io/managed-by`) and
          metadata.labels.`operator.kyma-project.io/managed-by` = 'kyma'
        source: '$base64decode($btpSecret().data.clientid)'
        children:
          - name: Cluster ID
            source: '$base64decode($btpSecret().data.cluster_id)'
          - name: Service Manager URL
            source: '$base64decode($btpSecret().data.sm_url)'
          - name: Token URL
            source: '$base64decode($btpSecret().data.tokenurl)'
          - name: Credentials Namespace
            source: >-
              ($exists($btpSecret().data.credentials_namespace) ? $base64decode($btpSecret().data.credentials_namespace) : 'kyma-system')
            widget: Text
      - name: Service Instances and Bindings
        widget: Panel
        children:
          - name: Service Instances
            widget: Table
            source: '$relatedServiceInstances().items'
            name: instances
            disableHiding: true
            children:
              - source: '$count($)'
                name: Total Count
                visibility: header
              - widget: ResourceLink
                source: '"See details"'
                name: Details
                resource:
                  name: '"serviceinstances.services.cloud.sap.com"'
                  kind: '"CustomResourceDefinition"'
                  namespace: '""'
          - name: Service Bindings  
            widget: Table
            source: '$relatedServiceBindings().items'
            name: bindings
            disableHiding: true
            children:
              - source: '$count($)'
                name: Total Count
                visibility: header
              - widget: ResourceLink
                source: '"See details"'
                name: Details
                resource:
                  name: '"servicebindings.services.cloud.sap.com"'
                  kind: '"CustomResourceDefinition"'
                  namespace: '""'
      - name: Secrets Monitoring
        widget: Panel
        children:
          - name: Secrets Types
            source: '"See Secrets Management Documentation"'
            link: '"https://github.com/SAP/sap-btp-service-operator?tab=readme-ov-file#configuring-multiple-subaccounts"'
            widget: ExternalLink
          - name: Default Secret (sap-btp-service-operator)
            widget: Panel
            children:
              - widget: Table
                source: '$defaultSecret().items'
                children:
                  - source: '$item.metadata.name'
                    name: Name
                  - source: '$item.metadata.namespace'
                    name: Namespace
                  - source: '$item.metadata.creationTimestamp'
                    name: Created
          - name: Namespaced Secrets ({namespace}-sap-btp-service-operator)
            widget: Panel
            children:
              - widget: Table
                source: '$namespacedSecrets().items'
                children:
                  - source: '$item.metadata.name'
                    name: Name
                  - source: '$item.metadata.namespace'
                    name: Namespace
                  - source: '$item.metadata.creationTimestamp'
                    name: Created
          
          - name: Referenced Secrets (from ServiceInstance.spec.btpAccessCredentialsSecret)
            widget: Panel
            children:
              - widget: Table
                source: '$referencedSecrets().items'
                children:
                  - source: '$item.metadata.name'
                    name: Name
                  - source: '$item.metadata.namespace'
                    name: Namespace
                  - source: '$item.metadata.creationTimestamp'
                    name: Created
                  - source: '$item.metadata.name'
                    name: Details
                    widget: ResourceLink
                    resource:
                      name: '$item.metadata.name'
                      namespace: '$item.metadata.namespace'
                      kind: '"Secret"'


name: Auto update chart/resources

env:
  KYMA_BTP_MANAGER_REPO: ${{ github.repository_owner }}/btp-manager
  SAP_BTP_SERVICE_OPERATOR_REPO: https://github.com/sap/sap-btp-service-operator
  GIT_EMAIL: team-gopher+1@sap.com
  GIT_NAME: kyma-btp-manager-bot
on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *' 

jobs:
 
  auto-bump-chart:
    runs-on: ubuntu-latest

    steps:

    - uses: actions/checkout@v3

    - name: Compare tags
      run: |
        latest=$(curl -sL -H "Accept: application/vnd.github+json" https://api.github.com/repos/SAP/sap-btp-service-operator/releases/latest | jq -r '.tag_name')
        current=$(yq '.version' ./module-chart/chart/Chart.yaml)
        if [[ $latest == $current ]]; then
          echo "versions are the same: $latest=$current"
          echo "CONTINUE_JOB=false" >> $GITHUB_ENV
        else
          echo "version update from $current to $latest"
          echo "CONTINUE_JOB=true" >> $GITHUB_ENV
          echo "TAG=${latest}" >> $GITHUB_ENV
          echo "BRANCH_NAME=chart-${latest}" >> $GITHUB_ENV
          echo "MSG=Update module chart and resources to ${latest}" >> $GITHUB_ENV
        fi

    - name: Update chart and module resources
      if: env.CONTINUE_JOB
      run: |
        scripts/update/make-module-chart.sh $TAG
        scripts/update/make-module-resources.sh $TAG

    - name: Check if there are any changes
      if: env.CONTINUE_JOB
      env:
        GH_TOKEN: ${{ secrets.BOT_TOKEN }}
      run: |
        prs=$(gh pr list -A $GIT_NAME --state open --json headRefName | jq -r '.[] | .headRefName')
        if echo $prs | tr " " '\n' | grep -F -q -x $BRANCH_NAME; then
          echo "PR already exists, no need to create a new one"
          echo "CONTINUE_JOB=false" >> $GITHUB_ENV
        elif [ -z "$(git status --porcelain)" ]; then
          echo "nothing changed, skipping remaining steps"
          echo "CONTINUE_JOB=false" >> $GITHUB_ENV
        else
          echo "CONTINUE_JOB=true" >> $GITHUB_ENV
        fi

    - name: Pass changes
      if: env.CONTINUE_JOB
      run: |
        git config --global user.email $GIT_EMAIL
        git config --global user.name $GIT_NAME 
        git add module-chart/* 
        git add module-resources/* 
        git add controllers/btpoperator_controller.go
        git add config/rbac/role.yaml 
        git stash push --staged

    - name: Create PR
      if: env.CONTINUE_JOB
      env:
        GH_TOKEN: ${{ secrets.BOT_TOKEN }}
      run: |
        git checkout --force -B main refs/remotes/origin/main
        git checkout -B ${BRANCH_NAME}
        git stash apply
        git add module-chart/*
        git add module-resources/*
        git add controllers/btpoperator_controller.go
        git add config/rbac/role.yaml
        git commit -m "$MSG"
        git remote set-url origin https://x-access-token:${GH_TOKEN}@github.com/${KYMA_BTP_MANAGER_REPO}.git
        git push --set-upstream origin ${BRANCH_NAME} -f
        pr_link=$(gh pr create -B main --title "${MSG}" --body "https://${SAP_BTP_SERVICE_OPERATOR_REPO}/releases/tag/${TAG}" | tail -n 1)
        echo "Link for created PR: ${pr_link}"
        echo "pr_link=${pr_link}" >> $GITHUB_ENV

    - name: Link PR to dashboard
      if: env.CONTINUE_JOB
      env:
        GH_TOKEN: ${{ secrets.BOT_TOKEN }}
      run: |
        pr_number=$(echo "${pr_link}" | awk -F '/' '{print($NF)}')
        pr_id=$(gh api repos/kyma-project/btp-manager/pulls/"${pr_number}" | jq -r '.node_id')        
        # Gopher board node_id
        project_board_id=PVT_kwDOAlVvc84AEv0v
        # "To Do" column on Gopher board node_id
        todo_column_id=834c7033
        # order in "To Do" column on Gopher board node_id
        status_field=PVTSSF_lADOAlVvc84AEv0vzgCvCtY

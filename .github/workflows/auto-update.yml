name: Auto update chart/resources

env:
  ORG: ukff
  BTP_MANAGER_REPO: btp-manager
  GIT_EMAIL: team-gopher+1@sap.com
  GIT_NAME: kyma-btp-manager-bot
on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *' 

jobs:
  auto-bump-chart:
    runs-on: ubuntu-latest

    steps:

    - uses: actions/checkout@v3

    - name: Check for new version
      run: |
        chmod +x hack/update/get-latest-chart-version.sh 
        latest=$(hack/update/get-latest-chart-version.sh)
        current=$(yq '.version' ./module-chart/chart/Chart.yaml)
        if [[ $latest == $current ]]; then
          echo "version are the same: $latest=$current"
          echo "CONTINUE=false" >> $GITHUB_ENV
        else
          echo "version update from $current to $latest"
          echo "CONTINUE=true" >> $GITHUB_ENV
          echo "TAG=${latest}" >> $GITHUB_ENV
        fi

    - name: Update chart
      if: env.CONTINUE == 'true'
      run: |
        chmod +x hack/update/make-module-chart.sh
        hack/update/make-module-chart.sh $TAG

    - name: Make templates
      if: env.CONTINUE == 'true'
      run: |
        chmod +x hack/update/make-module-resources.sh
        hack/update/make-module-resources.sh $TAG

    - name: Configure Git
      if: env.CONTINUE == 'true'
      run: |
        git config --global user.email $GIT_EMAIL
        git config --global user.name $GIT_NAME
 
        echo "BRANCH_NAME=chart-$TAG" >> $GITHUB_ENV
        echo "MSG=Update module chart and resources to $TAG" >> $GITHUB_ENV

    - name: Check if there are changes
      if: env.CONTINUE == 'true'
      shell: bash
      run: |
        prs=$(gh pr list -A $GIT_NAME --state open --json headRefName | jq -r '.[] | .headRefName')
        if echo $prs | tr " " '\n' | grep -F -q -x $BRANCH_NAME; then
          echo "open pr already exists, no need to create new one"
          echo "CONTINUE=false" >> $GITHUB_ENV
        elif [ -z "$(git status --porcelain)" ]; then
          echo "nothing changed, exiting"
          echo "CONTINUE=false" >> $GITHUB_ENV
        else
          echo "CONTINUE=true" >> $GITHUB_ENV
        fi
      env:
        GH_TOKEN: ${{ secrets.BOT_TOKEN }}

    - name: Pass changes
      if: env.CONTINUE == 'true'
      run: |
        git add module-chart/* 
        git add module-resources/* 
        git stash push --staged

    - uses: actions/checkout@v3
      if: env.CONTINUE == 'true'
      with:
        ref: main

    - name: Create PR
      if: env.CONTINUE == 'true'
      run: |
        git checkout -B $BRANCH_NAME
        git stash apply
        git add module-chart/* 
        git add module-resources/*
        git commit -m "$MSG"
        git remote set-url origin https://x-access-token:${{ secrets.BOT_TOKEN }}@github.com/$ORG/$BTP_MANAGER_REPO.git
        git push --set-upstream origin $BRANCH_NAME -f
        gh pr create -B main --title "$MSG" --body ""
      env:
        GH_TOKEN: ${{ secrets.BOT_TOKEN }}
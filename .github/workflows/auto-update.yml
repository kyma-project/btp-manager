name: Auto update chart/resources

env:
  KYMA_BTP_MANAGER_REPO: ${{ github.repository_owner }}/btp-manager
  SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
  SAP_BTP_SERVICE_OPERATOR_REPO: https://github.com/sap/sap-btp-service-operator
  GIT_EMAIL: team-gopher+1@sap.com
  GIT_NAME: kyma-gopher-bot
  EXTERNAL_IMAGES_REPO: ${{ vars.EXTERNAL_IMAGES_REPO }}
on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *' 
permissions:
  contents: write
jobs:
  auto-update-chart-and-module-resources:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up go environment
        uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'

      - name: Compare tags
        run: |
          LATEST=$(scripts/update/get-latest-chart-version.sh)
          CURRENT=$(yq '.version' ./module-chart/chart/Chart.yaml)
          if [[ $LATEST == $CURRENT ]]; then
            echo "versions are the same: $LATEST=$CURRENT"
            echo "UPDATE_CHART=false" >> $GITHUB_ENV
          else
            echo "version update from $CURRENT to $LATEST"
            echo "UPDATE_CHART=true" >> $GITHUB_ENV
          fi
          echo "TAG=${LATEST}" >> $GITHUB_ENV
          echo "BASE_BRANCH_NAME=chart-${LATEST}" >> $GITHUB_ENV

      - name: Update chart
        if: env.UPDATE_CHART == 'true'
        run: scripts/update/make-module-chart.sh $TAG
      
      - name: Update external images
        if: env.UPDATE_CHART == 'true'
        run: scripts/update/update-external-images.sh

      - name: Create PR for image-syncer
        if: env.UPDATE_CHART == 'true'
        env:
          GH_TOKEN: ${{ secrets.BOT_TOKEN }}
        run: |
          export BRANCH_NAME=${BASE_BRANCH_NAME}-update-chart-and-external-images
          echo "BRANCH_NAME=${BRANCH_NAME}" >> $GITHUB_ENV
          export MSG="Update module chart to ${TAG}"
          PRS=$(gh pr list -A $GIT_NAME --state open --json headRefName | jq -r '.[] | .headRefName')
          if echo $PRS | tr " " '\n' | grep -F -q -x ${BRANCH_NAME}; then
            echo "PR already exists, no need to create a new one"
            echo "CHART_UPDATE_PR_NUMBER=$(gh pr list --search "base:main head:${BRANCH_NAME}" --json number | jq -r '.[] | .number')" >> $GITHUB_ENV
          elif [ -z "$(git status --porcelain)" ]; then
            echo "Nothing changed, no need to create PR"
            echo "CHART_UPDATE_PR_NUMBER=-1" >> $GITHUB_ENV
          else
            PR_STATUS=$(scripts/update/create_pr_module_chart.sh)
            echo "CHART_UPDATE_PR_NUMBER=$(echo "$PR_STATUS" | tail -n 1)" >> $GITHUB_ENV
          fi
          
      - name: All checks passed
        if: env.UPDATE_CHART == 'true'
        timeout-minutes: 20
        env:
          GH_TOKEN: ${{ secrets.BOT_TOKEN }}
          PR_NUMBER: ${{ env.CHART_UPDATE_PR_NUMBER }}
        run: |
          sleep 10
          while true; do
            RESULT=$(gh pr checks "$PR_NUMBER" --json bucket,name \
              --jq '.[] | select(.name == "checks-passed") | .bucket')

            if [[ "$RESULT" == "pass" ]]; then
              echo "All checks passed"
              exit 0
            elif [[ "$RESULT" == "fail" || "$RESULT" == "cancel" ]]; then
              echo "Checks failed"
              exit 1
            fi

            echo "Pending, trying again in 30 seconds..."
            sleep 30
          done

      - name: Merge PR
        if: env.UPDATE_CHART == 'true'
        env:
          GH_TOKEN: ${{ secrets.BOT_TOKEN }}
          REPOSITORY: ${{ env.KYMA_BTP_MANAGER_REPO }}
          PR_NUMBER: ${{ env.CHART_UPDATE_PR_NUMBER }}
        run: |
          if [ "$PR_NUMBER" -gt 0 ]; then
            scripts/merge_pr.sh
          else
            echo "Step skipped"
          fi
      
      - name: Await PR merge
        if: env.UPDATE_CHART == 'true'
        timeout-minutes: 5
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ env.CHART_UPDATE_PR_NUMBER }}
        run: |
          if [ "$PR_NUMBER" -gt 0 ]; then
            scripts/await_pr_merge.sh
            git push origin -d $BRANCH_NAME
          else
            echo "Step skipped"
          fi
      
      - name: Wait for sap-btp-service-operator image
        if: env.UPDATE_CHART == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          EXTERNAL_IMAGE=$(yq '.images[] | select(.source | contains("sap-btp-service-operator")) | .source' external-images.yaml)
          scripts/await_image.sh "${EXTERNAL_IMAGES_REPO}/${EXTERNAL_IMAGE}"

      - name: Wait for kube-rbac-proxy image
        if: env.UPDATE_CHART == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          EXTERNAL_IMAGE=$(yq '.images[] | select(.source | contains("kube-rbac-proxy")) | .source' external-images.yaml)
          scripts/await_image.sh "${EXTERNAL_IMAGES_REPO}/${EXTERNAL_IMAGE}"

      - name: Checkout code after chart update and external images sync
        if: env.UPDATE_CHART == 'true'
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Pull latest changes
        if: env.UPDATE_CHART == 'true'
        run: git pull

      - name: Check if PR with module resources update is required
        env:
          GH_TOKEN: ${{ secrets.BOT_TOKEN }}
        run: |
          export BRANCH_NAME=${BASE_BRANCH_NAME}-update-resources
          echo "BRANCH_NAME=${BRANCH_NAME}" >> $GITHUB_ENV
          PRS=$(gh pr list -A $GIT_NAME --state all --json headRefName | jq -r '.[] | .headRefName')
          if echo $PRS | tr " " '\n' | grep -F -q -x $BRANCH_NAME; then
            echo "PR already exists, no need to create a new one"
            echo "UPDATE_RESOURCES=false" >> $GITHUB_ENV
          else
            echo "No existing PR found, module resources update might be required"
            echo "UPDATE_RESOURCES=true" >> $GITHUB_ENV
          fi
      
      - name: Update module resources
        if: env.UPDATE_RESOURCES == 'true'
        run: scripts/update/make-module-resources.sh $TAG

      - name: Set images as envs in module deployment
        if: env.UPDATE_RESOURCES == 'true'
        run: scripts/update/add_module_managed_images_envs.sh

      - name: Create PR for module resources update
        if: env.UPDATE_RESOURCES == 'true'
        env:
          GH_TOKEN: ${{ secrets.BOT_TOKEN }}
        run: |
          export MSG="Update module resources to ${TAG}"
          if [ -z "$(git status --porcelain)" ]; then
            echo "Nothing changed, no need to create PR"
          else
            scripts/update/create_pr_module_resources.sh
          fi

      - name: Notify slack channel about failure
        if: ${{ !success() && env.SLACK_BOT_TOKEN != ''}}
        uses: slackapi/slack-github-action@v2.1.1
        with:
          channel-id: 'kyma-gopher-private-alerts'
          slack-message: "Auto-update of BTP Manager has failed. Check the details at: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

      - name: Notify MS Teams channel about failure
        if: ${{ !success() }}
        env:
          MS_TEAMS_TOKEN_URL: ${{ secrets.MS_TEAMS_TOKEN_URL }}
          MS_TEAMS_CLIENT_ID: ${{ secrets.MS_TEAMS_CLIENT_ID }}
          MS_TEAMS_CLIENT_SECRET: ${{ secrets.MS_TEAMS_CLIENT_SECRET }}
          MS_TEAMS_SCOPE: ${{ secrets.MS_TEAMS_SCOPE }}
          MS_TEAMS_WEBHOOK_URL: ${{ secrets.MS_TEAMS_WEBHOOK_URL }}
        run: |
          MESSAGE="‚ùå <strong>Auto-update of BTP Manager has failed. <a href='${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'>View details</a>"
          ./scripts/notify_teams.sh "$MESSAGE"
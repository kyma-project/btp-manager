name: "Upload release logs as assets"
run-name: Upload release ${{ github.event.release.tag_name }} logs as assets
on:
  release:
    types: [released]

permissions:
  contents: write

jobs:
  upload-release-logs:
    runs-on: ubuntu-latest
    env:
      COMBINED_ZIP: ${{ github.event.repository.name }}_${{ github.event.release.tag_name }}.zip
    steps:
      - name: Check out repository
        uses: actions/checkout@v6

      - name: Wait for release workflow to finish if in progress
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking if a release workflow is in progress..."
          while true; do
            IN_PROGRESS=$(gh run list --workflow "Create release and submit module version" --json status -L 1 --jq '.[] | select(.status == "in_progress") | .status')
            if [ -z "$IN_PROGRESS" ]; then
              echo "No release workflow in progress."
              echo "Waiting 10 seconds for logs to be available..."
              sleep 10
              break
            fi
            echo "Release workflow is in progress. Waiting 30 seconds..."
            sleep 30
          done

      - name: Download logs from all attempts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          REPO_NAME: ${{ github.event.repository.name }}
          RELEASE_VERSION: ${{ github.event.release.tag_name }}
        run: ./scripts/download_workflow_logs.sh "Create release and submit module version" "Create release ${{ github.event.release.tag_name }}"

      - name: Upload logs as release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Uploading $COMBINED_ZIP to release ${{ github.event.release.tag_name }}..."
          gh release upload ${{ github.event.release.tag_name }} "$COMBINED_ZIP" --repo "$GITHUB_REPOSITORY" --clobber

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.RELEASE_LOG_UPLOADER_SA }}

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ vars.GCP_KYMA_PROJECT_PROJECT_ID }}

      - name: Upload report to the GCP bucket
        run: gsutil cp "$COMBINED_ZIP" gs://kyma_release_test_logs/

      - name: Notify MS Teams channel about failure
        if: ${{ !success() }}
        env:
          MS_TEAMS_TOKEN_URL: ${{ secrets.MS_TEAMS_TOKEN_URL }}
          MS_TEAMS_CLIENT_ID: ${{ secrets.MS_TEAMS_CLIENT_ID }}
          MS_TEAMS_CLIENT_SECRET: ${{ secrets.MS_TEAMS_CLIENT_SECRET }}
          MS_TEAMS_SCOPE: ${{ secrets.MS_TEAMS_SCOPE }}
          MS_TEAMS_WEBHOOK_URL: ${{ secrets.MS_TEAMS_WEBHOOK_URL }}
        run: |
          MESSAGE="‚ùå <strong>Logs uploading to release failed. <a href='${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'>View details</a>"
          ./scripts/notify_teams.sh "$MESSAGE"

      - name: Notify slack channel about failure
        if: ${{ !success() }}
        uses: slackapi/slack-github-action@v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: kyma-gopher-private-alerts
            text: "Logs uploading to release failed. Check the details at: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"